\chapter[Event generation, simulation, reconstruction]{Event generation, simulation and
reconstruction \label{chap:event_generation}}

In the previous chapter I discussed how $\Pp\Pp$ collisions are produced by the LHC, and
how they are detected by CMS. This chapter will elaborate on the different
steps needed to actually use the collisions for physics analysis. 
First, I will explain more details about the collisions, or \textit{events}, themselves. I will
discuss the separate components an event consists of, as well as touch upon how events are described
mathematically. 

In order to understand what we observe in the data, which might contain signals of new physics, it
is important to know how Standard Model processes will appear in the detector. To achieve this we
generate those processes using Monte Carlo generation techniques, incorporating everything that is
known about how the Standard Model works. The principal options that are available to generate
events will be discussed in Section~\ref{sec:event_generation}. 
For each generated collision, we obtain a set of final state particles according to the specified
physics process. This could for example be the particles that result from the production and decay
of a top quark. 
At this stage we do not know yet how these particles would interact with the detector. That is
taken care of in a next step by the event simulation, as explained in
Section~\ref{sec:event_simulation}. An event simulator mimics how a particle, \eg an electron,
would interact with all the different detector layers, and stores the response of the detector in
the same format as the actual detector data. 

At this point the simulated data and the real data are very similar, but are stored in a raw format,
containing detector hits and energy depositions, rather than physics objects. This format is hard to
use for further analysis. The final step will thus be to perform the event reconstruction. The
purpose of event reconstruction is to convert the raw detector information, be it real or simulated,
into physical objects, such as electrons, muons, photons, charged or neutral hadrons. Each of those
objects comes with a set of defining variables, which can be very basic (e.g. \pt, $\eta$ or $\phi$)
or more complex (e.g. shower shape). The different algorithms and techniques that are used within
CMS for this purpose are detailed in Section~\ref{sec:event_reconstruction}. 

\section{What is an ``event''? \label{sec:event}}

\input{event_what_is_an_event.tex}


\section{Event generation \label{sec:event_generation}}

\input{event_generation.tex}


\section{Event simulation \label{sec:event_simulation}}

\input{event_simulation.tex}


\section{Event reconstruction \label{sec:event_reconstruction}}

\input{event_reconstruction.tex}


\subsection{Physics object identification \label{sec:event_objects}}

The event selection is an integral part of any physics analysis. It determines which events are
used, and thus what processes contribute to the data sample. This in turn drives how the
backgrounds are estimated, what the sensitivity will be, etcetera. 
An event selection is most easily described in terms of particles, \eg two electrons, no muons, at
least four jets, as this is the closest to how we think about a given process.  
The particle flow technique described in the previous section is very compatible with this approach,
given that it reconstructs a fully consistent set of identified particles out of the detector hits. 
However, a more thorough selection of the PF objects is needed in order to ensure that their
behaviour is understood, and to ensure that the selected events are not dominated by
misidentified particles, or detector artefacts. 
The physics object groups (POG's) within the CMS Collaboration are in charge of providing general
recommendations on how to define each object. These recommendations are based on extensive studies,
and are applicable for most analyses, thus reducing the workload for the analysis teams.
In the following paragraphs all the standard objects that will be used in the razor boost analysis
are discussed.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\input{event_objects.tex}


\subsection{Event cleaning \label{sec:event_cleaning}}

The full CMS data taking and event reconstruction process is very intricate. Every now and then a
subdetector might not have behaved properly, or a reconstruction algorithm could have failed. 
Events affected by such failures need to be removed from the selection, as they can create
artificially high missing transverse momentum and would then end up in the signal region of many
supersymmetry searches. 
The following cleaning filters are applied:

\begin{itemize}
\item The {\tt EcalDeadCellTriggerPrimitiveFilter}, which removes events where dead cells in the
ECAL produce anomalous activity.
\item The {\tt hcalLaserEventFilter}, which removes events where the HCAL laser produces anomalous
activity.
%\item The {\tt hcalLaserEventFilter2012}, 
\item The {\tt trackingFailureFilter}, which removes events where the tracking algorithm does not
perform properly.
\item The {\tt CSCTightHaloFilter}, which removes events contaminated by beam halo.
\item The {\tt HBHENoiseFilter}, which removes events featuring large hadronic calorimeter noise.
\item The {\tt eeBadScFilter}, which removes events featuring high amplitude anomalous pulses due
to bad ECAL super-crystals.
\item The {\tt trkPOGFilters}, which remove events due to track reconstruction anomalies, such as
events with partly aborted track reconstruction and events affected by the Strip Tracker coherent
noise.
\item The {\tt primaryVertexFilter}, which removes events that do not have a good primary vertex.
\item The {\tt noscrapingFilter}, which removes events with a large multiplicity of low quality
tracks.
\end{itemize}

More details on these filters can be found in Ref.~\cite{metfilters}. The effect on the \ETm
distribution is shown in Fig.~\ref{fig:event_metcleaning}. There is a very clear reduction in the
\ETm tail in data, which brings data and simulation in agreement. 
The {\tt CSCTightHaloFilter} and {\tt HBHENoiseFilter} filters are not applied for simulated samples
that are passed through the fast CMS detector simulation because the necessary input collections are
not produced.

\begin{figure}[tpb]
  \centering
  \includegraphics[width=0.6\textwidth]{figures/eventreco_objects/METTail}
  \caption{ The PF \VEtmiss distribution for events passing a dijet selection without cleaning
filters applied (open markers), with cleaning filters applied (filled markers), and simulated
events (filled histograms). Figure taken from Ref.~\cite{Khachatryan:2014gga}.
  \label{fig:event_metcleaning}}
\end{figure}

\paragraph{HCAL noise filter}

In addition to the standard filters listed above, we also use an extra cleaning selection designed
to remove events with spurious HCAL noise originating in the outer barrel of the HCAL. 
Energy deposits in the HO are included in the computation of the missing transverse momentum using 
the particle flow algorithm, but are not included in the missing transverse energy
obtained from calorimeter information only. 
A selection requiring no substantial discrepancy between the two \ETm definitions is thus effective
at reducing the contribution of these noisy events. 

We reject events in which the PF missing transverse energy vector, $\VEtmiss(\text{PF})$, is
flipped with respect to the calorimeter based one, $\VEtmiss(\text{Calo})$. 
To accomplish this we compute the absolute value of the difference in polar angle,
 $|\Delta\phi_{\text{PF,Calo}}|$, taken in the range $[0,2\pi[$, and defined as
\begin{equation}
|\Delta\phi_{\text{PF,Calo}}| = \min \left ( \phi^{\text{PF}} - \phi^{\text{Calo}},   2\pi -
\phi^{\text{PF}} + \phi^{\text{Calo}} \right) ,\\
\end{equation}
with 
\begin{equation}
\phi^{\text{PF/Calo}} = \textrm{arctan} \left( \frac{\VEtmiss(\text{PF/Calo})|_y}
{\VEtmiss(\text{PF/Calo})|_x} \right) . \\
%\phi^{\text{Calo}} &= \textrm{arctan}\left( \frac{\VEtmiss(\text{Calo})|_y}
%{\VEtmiss(\text{Calo})|_x} \right) .
\end{equation}
Events for which $|\Delta\phi_{\text{PF,Calo}}|$ falls in a 1 radian window centred around $\pi$
are removed. 
\begin{equation}
\bigl| |\Delta\phi_{\text{PF,Calo}}| - \pi \bigr| < 1
\label{eqn:dphicut}
\end{equation}


\subsection{Event reweighting \label{sec:event_reweighting}}

The generation and simulation of events are tuned to mimic the data. However, the complete data
taking conditions, in particular the pileup profile, are not fully known before data
taking starts. It is thus impossible to mimic the data in all aspects. 
Furthermore, the event generation itself is also not perfect. 
Many details of the hadronization process are still unknown, and state of the art event
generators can only compute hard physics processes up to maximally NLO precision,
whereas data contains all orders.  
All these effects can lead to discrepancies between the observed data and the simulation.  

To correct for some of these imperfections, event reweighting prescriptions have been developed. I
have already mentioned some correction factors that should be applied to various objects, such as
the jet energy scale corrections for jets. 
In the next subsections I will cover the reweightings that have to be applied to the full event,
rather than a particular object. These include the corrections for mismodelling of the pileup
distribution, the initial state radiation, and the top quark \pt spectrum for the
$t\bar{t}$ simulation.

\input{event_reweighting.tex}
